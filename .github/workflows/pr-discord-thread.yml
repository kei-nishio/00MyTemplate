name: PR â†’ Discord thread notify

on:
  # pull_request_target ã‚’ä½¿ç”¨ã™ã‚‹ç†ç”±:
  # 1. ã‚·ãƒ¼ã‚¯ãƒ¬ãƒƒãƒˆã‚’ä½¿ç”¨ã™ã‚‹ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ã¯ãƒ™ãƒ¼ã‚¹ãƒ–ãƒ©ãƒ³ãƒï¼ˆmainï¼‰ã‹ã‚‰å®Ÿè¡Œã™ã¹ã
  # 2. PRã®ã‚³ãƒ¼ãƒ‰è‡ªä½“ã¯å®Ÿè¡Œã›ãšã€ãƒ¡ã‚¿ãƒ‡ãƒ¼ã‚¿ã®ã¿ä½¿ç”¨ã™ã‚‹ãŸã‚å®‰å…¨
  # 3. main ã¸ã®ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ä¿®æ­£ãŒå³åº§ã«å…¨PRã«åæ˜ ã•ã‚Œã‚‹
  pull_request_target:
    types:
      - opened

jobs:
  notify:
    runs-on: ubuntu-latest

    steps:
      # å¿…è¦ãªã‚·ãƒ¼ã‚¯ãƒ¬ãƒƒãƒˆã®æ¤œè¨¼
      - name: Validate required secrets
        run: |
          if [ -z "${{ secrets.DISCORD_CHANNEL_ID }}" ]; then
            echo "Error: DISCORD_CHANNEL_ID secret is not set"
            exit 1
          fi
          if [ -z "${{ secrets.DISCORD_BOT_TOKEN }}" ]; then
            echo "Error: DISCORD_BOT_TOKEN secret is not set"
            exit 1
          fi
      # jqã®ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
      - name: Install jq
        run: sudo apt-get update && sudo apt-get install -y jq

      # ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒãƒƒãƒ”ãƒ³ã‚°ã®èª­ã¿è¾¼ã¿
      - name: Load user mapping
        run: |
          echo "Loading user mapping from Gist..."
          if ! curl -L -s --fail \
            "https://gist.githubusercontent.com/kei-nishio/fa1ed0f2f7e410bde57b8fac87c4e938/raw/usermap.json" \
            -o usermap.json; then
            echo "Warning: Failed to load user mapping. Creating empty mapping."
            echo '{}' > usermap.json
          fi

          echo "User mapping loaded:"
          jq '.' usermap.json
      # PRæƒ…å ±ã®æŠ½å‡º
      - name: Extract PR information
        id: pr_info
        env:
          PR_TITLE: ${{ github.event.pull_request.title }}
        run: |
          # ä½œæˆè€…
          echo "AUTHOR=${{ github.event.pull_request.user.login }}" >> $GITHUB_OUTPUT

          # ã‚¿ã‚¤ãƒˆãƒ«ï¼ˆDiscordã®ã‚¹ãƒ¬ãƒƒãƒ‰ååˆ¶é™100æ–‡å­—ã«å¯¾å¿œï¼‰
          # ç’°å¢ƒå¤‰æ•°çµŒç”±ã§æ¸¡ã™ã“ã¨ã§ç‰¹æ®Šæ–‡å­—ï¼ˆãƒãƒƒã‚¯ã‚¯ã‚©ãƒ¼ãƒˆã€ã‚·ãƒ³ã‚°ãƒ«ã‚¯ã‚©ãƒ¼ãƒˆç­‰ï¼‰ã®å•é¡Œã‚’å›é¿
          TITLE="$PR_TITLE"
          if [ ${#TITLE} -gt 100 ]; then
            TITLE="${TITLE:0:97}..."
            echo "Note: Title truncated to 100 characters for Discord thread name limit"
          fi
          {
            echo "TITLE<<EOF"
            echo "$TITLE"
            echo "EOF"
          } >> $GITHUB_OUTPUT

          # URL
          echo "URL=${{ github.event.pull_request.html_url }}" >> $GITHUB_OUTPUT

          # PRç•ªå·
          echo "PR_NUMBER=${{ github.event.pull_request.number }}" >> $GITHUB_OUTPUT
      # ãƒ¬ãƒ“ãƒ¥ã‚¢ãƒ¼ã¨ã‚¢ã‚µã‚¤ãƒ‹ãƒ¼ã®æŠ½å‡º
      - name: Extract reviewers and assignees
        id: users
        run: |
          # ãƒ¬ãƒ“ãƒ¥ã‚¢ãƒ¼ã®æŠ½å‡º
          reviewers=$(echo '${{ toJson(github.event.pull_request.requested_reviewers) }}' | jq -r '.[].login // empty')
          if [ -z "$reviewers" ]; then
            reviewers=""
          fi
          {
            echo 'REVIEWERS<<EOF'
            echo "$reviewers"
            echo 'EOF'
          } >> $GITHUB_OUTPUT

          # ã‚¢ã‚µã‚¤ãƒ‹ãƒ¼ã®æŠ½å‡º
          assignees=$(echo '${{ toJson(github.event.pull_request.assignees) }}' | jq -r '.[].login // empty')
          if [ -z "$assignees" ]; then
            assignees=""
          fi
          {
            echo 'ASSIGNEES<<EOF'
            echo "$assignees"
            echo 'EOF'
          } >> $GITHUB_OUTPUT
      # ãƒ¡ãƒ³ã‚·ãƒ§ãƒ³ã®è§£æ±º
      - name: Resolve Discord mentions
        id: mention
        run: |
          # ãƒ¡ãƒ³ã‚·ãƒ§ãƒ³å–å¾—ç”¨ã®é–¢æ•°
          get_discord_id() {
            local github_username="$1"
            local discord_id=$(jq -r --arg k "$github_username" '.[$k] // "null"' usermap.json)
            if [ "$discord_id" != "null" ] && [ -n "$discord_id" ]; then
              echo "$discord_id"
            fi
          }

          mentions=""

          # ä½œæˆè€…ã®ãƒ¡ãƒ³ã‚·ãƒ§ãƒ³
          author="${{ steps.pr_info.outputs.AUTHOR }}"
          author_id=$(get_discord_id "$author")
          if [ -n "$author_id" ]; then
            mentions="<@$author_id>"
          fi

          # ãƒ¬ãƒ“ãƒ¥ã‚¢ãƒ¼ã®ãƒ¡ãƒ³ã‚·ãƒ§ãƒ³
          while IFS= read -r reviewer; do
            [ -z "$reviewer" ] && continue
            reviewer_id=$(get_discord_id "$reviewer")
            if [ -n "$reviewer_id" ]; then
              [ -n "$mentions" ] && mentions="$mentions "
              mentions="${mentions}<@$reviewer_id>"
            fi
          done <<< "${{ steps.users.outputs.REVIEWERS }}"

          {
            echo 'MENTIONS<<EOF'
            echo "$mentions"
            echo 'EOF'
          } >> $GITHUB_OUTPUT

          echo "Resolved mentions: $mentions"
      # Discord APIã‚³ãƒ¼ãƒ«ç”¨ã®é–¢æ•°å®šç¾©
      - name: Setup Discord API functions
        run: |
          cat << 'SCRIPT' > discord_api.sh
          #!/bin/bash
          set -e

          # Discord APIã‚³ãƒ¼ãƒ«é–¢æ•°
          discord_api_call() {
            local method="$1"
            local endpoint="$2"
            local data="$3"
            local output_file="$4"
            
            echo "Calling Discord API: $method $endpoint"
            
            response=$(curl -s -w "\n%{http_code}" -X "$method" \
              "https://discord.com/api/v10/$endpoint" \
              -H "Authorization: Bot $DISCORD_BOT_TOKEN" \
              -H "Content-Type: application/json" \
              ${data:+-d "$data"})
            
            http_code=$(echo "$response" | tail -n1)
            response_body=$(echo "$response" | sed '$d')
            
            echo "$response_body" > "$output_file"
            
            # HTTPã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã‚³ãƒ¼ãƒ‰ã®ç¢ºèª
            if [ "$http_code" -lt 200 ] || [ "$http_code" -ge 300 ]; then
              echo "Error: Discord API returned HTTP $http_code"
              echo "Response: $response_body"
              return 1
            fi
            
            echo "Success: HTTP $http_code"
            return 0
          }

          export -f discord_api_call
          SCRIPT

          chmod +x discord_api.sh
          source discord_api.sh
      # ãƒ¡ã‚¤ãƒ³ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã®æŠ•ç¨¿
      - name: Post main message to Discord
        id: main_message
        env:
          DISCORD_BOT_TOKEN: ${{ secrets.DISCORD_BOT_TOKEN }}
          DISCORD_CHANNEL_ID: ${{ secrets.DISCORD_CHANNEL_ID }}
          PR_TITLE: ${{ steps.pr_info.outputs.TITLE }}
          PR_URL: ${{ steps.pr_info.outputs.URL }}
        run: |
          source discord_api.sh

          # ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸å†…å®¹ã®æº–å‚™
          message_text=$(printf "PRãŒã§ãã¾ã—ãŸã‚ˆï¼æ—©ãè¦‹ã«æ¥ã¦ãã ã•ã„ã€œï¼\n%s\n<%s>" \
            "$PR_TITLE" \
            "$PR_URL")

          # JSONãƒšã‚¤ãƒ­ãƒ¼ãƒ‰ã®ä½œæˆ
          payload=$(jq -n \
            --arg content "$message_text" \
            '{content: $content}')

          # APIã‚³ãƒ¼ãƒ«
          if ! discord_api_call "POST" "channels/$DISCORD_CHANNEL_ID/messages" "$payload" "main_message.json"; then
            echo "Failed to post main message to Discord"
            exit 1
          fi

          # ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸IDã®å–å¾—
          MESSAGE_ID=$(jq -r '.id' main_message.json)
          if [ -z "$MESSAGE_ID" ] || [ "$MESSAGE_ID" = "null" ]; then
            echo "Error: Failed to get message ID"
            exit 1
          fi

          echo "MESSAGE_ID=$MESSAGE_ID" >> $GITHUB_OUTPUT
          echo "Main message posted successfully. ID: $MESSAGE_ID"

      # ã‚¹ãƒ¬ãƒƒãƒ‰ã®ä½œæˆ
      - name: Create Discord thread
        id: thread
        env:
          DISCORD_BOT_TOKEN: ${{ secrets.DISCORD_BOT_TOKEN }}
          DISCORD_CHANNEL_ID: ${{ secrets.DISCORD_CHANNEL_ID }}
          PR_TITLE: ${{ steps.pr_info.outputs.TITLE }}
        run: |
          source discord_api.sh

          # ã‚¹ãƒ¬ãƒƒãƒ‰åã®æº–å‚™
          thread_name="$PR_TITLE"

          # JSONãƒšã‚¤ãƒ­ãƒ¼ãƒ‰ã®ä½œæˆ
          payload=$(jq -n \
            --arg name "$thread_name" \
            '{name: $name, auto_archive_duration: 1440}')

          # APIã‚³ãƒ¼ãƒ«
          if ! discord_api_call "POST" \
            "channels/$DISCORD_CHANNEL_ID/messages/${{ steps.main_message.outputs.MESSAGE_ID }}/threads" \
            "$payload" \
            "thread.json"; then
            echo "Failed to create Discord thread"
            exit 1
          fi

          # ã‚¹ãƒ¬ãƒƒãƒ‰IDã®å–å¾—
          THREAD_ID=$(jq -r '.id' thread.json)
          if [ -z "$THREAD_ID" ] || [ "$THREAD_ID" = "null" ]; then
            echo "Error: Failed to get thread ID"
            exit 1
          fi

          echo "THREAD_ID=$THREAD_ID" >> $GITHUB_OUTPUT
          echo "Thread created successfully. ID: $THREAD_ID"
      # ã‚¹ãƒ¬ãƒƒãƒ‰ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã®æŠ•ç¨¿
      - name: Post detailed message to thread
        env:
          DISCORD_BOT_TOKEN: ${{ secrets.DISCORD_BOT_TOKEN }}
          PR_AUTHOR: ${{ steps.pr_info.outputs.AUTHOR }}
          PR_URL: ${{ steps.pr_info.outputs.URL }}
          PR_NUMBER: ${{ steps.pr_info.outputs.PR_NUMBER }}
        run: |
          source discord_api.sh

          # ä½œæˆè€…æƒ…å ±
          author_info="- $PR_AUTHOR"
          author_discord_id=$(jq -r --arg k "$PR_AUTHOR" '.[$k] // "null"' usermap.json)
          if [ "$author_discord_id" != "null" ]; then
            author_info="${author_info}ï¼ˆ<@$author_discord_id>ï¼‰"
          fi

          # ãƒ¬ãƒ“ãƒ¥ã‚¢ãƒ¼ãƒªã‚¹ãƒˆã®ä½œæˆ
          reviewer_list=""
          if [ -n "${{ steps.users.outputs.REVIEWERS }}" ]; then
            while IFS= read -r reviewer; do
              [ -z "$reviewer" ] && continue
              reviewer_item="- $reviewer"
              reviewer_discord_id=$(jq -r --arg k "$reviewer" '.[$k] // "null"' usermap.json)
              if [ "$reviewer_discord_id" != "null" ]; then
                reviewer_item="${reviewer_item}ï¼ˆ<@$reviewer_discord_id>ï¼‰"
              fi
              [ -n "$reviewer_list" ] && reviewer_list="${reviewer_list}\n"
              reviewer_list="${reviewer_list}${reviewer_item}"
            done <<< "${{ steps.users.outputs.REVIEWERS }}"
          fi
          [ -z "$reviewer_list" ] && reviewer_list="- ãªã—"

          # ã‚¢ã‚µã‚¤ãƒ‹ãƒ¼ãƒªã‚¹ãƒˆã®ä½œæˆ
          assignee_list=""
          if [ -n "${{ steps.users.outputs.ASSIGNEES }}" ]; then
            while IFS= read -r assignee; do
              [ -z "$assignee" ] && continue
              assignee_item="- $assignee"
              assignee_discord_id=$(jq -r --arg k "$assignee" '.[$k] // "null"' usermap.json)
              if [ "$assignee_discord_id" != "null" ]; then
                assignee_item="${assignee_item}ï¼ˆ<@$assignee_discord_id>ï¼‰"
              fi
              [ -n "$assignee_list" ] && assignee_list="${assignee_list}\n"
              assignee_list="${assignee_list}${assignee_item}"
            done <<< "${{ steps.users.outputs.ASSIGNEES }}"
          fi
          [ -z "$assignee_list" ] && assignee_list="- ãªã—"

          # ãƒ¡ãƒ³ã‚·ãƒ§ãƒ³éƒ¨åˆ†ã®æº–å‚™
          mentions_text=""
          if [ -n "${{ steps.mention.outputs.MENTIONS }}" ]; then
            mentions_text="${{ steps.mention.outputs.MENTIONS }}"
          fi

          # ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã®çµ„ã¿ç«‹ã¦
          thread_message=$(printf "ï¼ï¼ï¼ï¼ï¼ï¼ï¼ï¼ï¼ï¼\nâ–  ä½œæˆè€…ï¼š\n%s\n\nâ–  ãƒ¬ãƒ“ãƒ¥ã‚¢ãƒ¼ï¼ˆReviewersï¼‰ï¼š\n%b\n\nâ–  æ‹…å½“è€…ï¼ˆAssigneesï¼‰ï¼š\n%b\n\nâ–  PR URLï¼š\n%s\n\nâ–  ãƒ­ãƒ¼ã‚«ãƒ«ã§ã®ãƒã‚§ãƒƒã‚¯ã‚¢ã‚¦ãƒˆæ–¹æ³•ï¼š\n\`\`\`\ngit switch main && git branch -D pr-test | echo pr-test branch is deleted! \ngit fetch origin pull/%s/head:pr-test\ngit switch pr-test\n\`\`\`\n\nï¼ï¼ï¼ï¼ï¼ï¼ï¼ï¼ï¼ï¼\n\næ—©ããƒ¬ãƒ“ãƒ¥ãƒ¼ã—ãªã„ã¨æœˆã«å¸°ã£ã¡ã‚ƒã„ã¾ã™ã‚ˆï¼Ÿ\n\n%s" \
            "$author_info" \
            "$reviewer_list" \
            "$assignee_list" \
            "$PR_URL" \
            "$PR_NUMBER" \
            "$mentions_text")

          # JSONãƒšã‚¤ãƒ­ãƒ¼ãƒ‰ã®ä½œæˆ
          payload=$(jq -n \
            --arg content "$thread_message" \
            '{content: $content}')

          # APIã‚³ãƒ¼ãƒ«
          if ! discord_api_call "POST" \
            "channels/${{ steps.thread.outputs.THREAD_ID }}/messages" \
            "$payload" \
            "thread_message.json"; then
            echo "Warning: Failed to post thread message, but main notification was sent"
            # ã‚¹ãƒ¬ãƒƒãƒ‰ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã®å¤±æ•—ã¯è­¦å‘Šã¨ã—ã¦æ‰±ã„ã€ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ã¯å¤±æ•—ã•ã›ãªã„
          else
            echo "Thread message posted successfully"
          fi

      # å®Œäº†ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸
      - name: Summary
        env:
          PR_TITLE: ${{ steps.pr_info.outputs.TITLE }}
          PR_URL: ${{ steps.pr_info.outputs.URL }}
          PR_AUTHOR: ${{ steps.pr_info.outputs.AUTHOR }}
        run: |
          echo "## ğŸ“¢ Discord Notification Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- **PR Title**: $PR_TITLE" >> $GITHUB_STEP_SUMMARY
          echo "- **PR URL**: $PR_URL" >> $GITHUB_STEP_SUMMARY
          echo "- **Author**: $PR_AUTHOR" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ğŸ‘¥ People" >> $GITHUB_STEP_SUMMARY
          echo "- **Reviewers**:" >> $GITHUB_STEP_SUMMARY
          if [ -n "${{ steps.users.outputs.REVIEWERS }}" ]; then
            while IFS= read -r reviewer; do
              [ -z "$reviewer" ] && continue
              echo "  - $reviewer" >> $GITHUB_STEP_SUMMARY
            done <<< "${{ steps.users.outputs.REVIEWERS }}"
          else
            echo "  - None" >> $GITHUB_STEP_SUMMARY
          fi
          echo "- **Assignees**:" >> $GITHUB_STEP_SUMMARY
          if [ -n "${{ steps.users.outputs.ASSIGNEES }}" ]; then
            while IFS= read -r assignee; do
              [ -z "$assignee" ] && continue
              echo "  - $assignee" >> $GITHUB_STEP_SUMMARY
            done <<< "${{ steps.users.outputs.ASSIGNEES }}"
          else
            echo "  - None" >> $GITHUB_STEP_SUMMARY
          fi
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ğŸ“Š Discord IDs" >> $GITHUB_STEP_SUMMARY
          echo "- **Discord Channel**: ${{ secrets.DISCORD_CHANNEL_ID }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Message ID**: ${{ steps.main_message.outputs.MESSAGE_ID }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Thread ID**: ${{ steps.thread.outputs.THREAD_ID }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "âœ… Notification sent successfully!" >> $GITHUB_STEP_SUMMARY
